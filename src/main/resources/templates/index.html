<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    #top {
        display: flex;
        flex-direction: row;
        justify-content: flex-end;
    }

    .tags {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
    }



    #logout {
        align:right;
    }
</style>

<body>
<div id="app">
    <div id="top" >
        <div v-if="user.name!=null">用户：{{user.name}}&nbsp&nbsp</div>
        <div id="logout" v-if="user.name!=null" v-on:click="logout()">注销</div>
        <div v-if="user.name==null" ><a href="/login.html">登陆</a></div>
    </div>
    <!--第一页-->
    <div id="movie_cinema" v-if="displayNum==1">
        <div class="tags">
            <div class="tag" v-on:click="list(1)">所有电影</div>
            <div class="tag" v-on:click="list(2)">所有影院</div>
        </div>
        <!--显示所有电影-->
        <table id="table1" v-if="listNum==1">
            <tr>
                <td>电影名</td>
                <td>描述</td>
                <td>票价</td>
                <td>影长</td>
                <td>购票</td>
            </tr>
            <tr v-for="movie in movies">
                <td>{{movie.name}}</td>
                <td>{{movie.description}}</td>
                <td>{{movie.price}}</td>
                <td>{{movie.movieLength}}分钟</td>
                <td v-on:click="setMovie(movie)">购票</td>
            </tr>
        </table>
        <!--显示所有影院-->
        <table id="table2" v-if="listNum==2">
            <tr>
                <td>电影院名</td>
                <td>地址</td>
                <td>购票</td>
            </tr>
            <tr v-for="cinema in cinemas">
                <td>{{cinema.name}}</td>
                <td>{{cinema.address}}</td>
                <td v-on:click="setCinema(cinema)">进入影院</td>
            </tr>
        </table>
    </div>
    <!--第二页，显示电影上映的影院信息-->
    <div id="movie" v-if="displayNum==2">
        <h3>{{selectedMovie.name}}</h3>
        <table id="table3">
            <tr>
                <td>影院名</td>
                <td>地址</td>
            </tr>
            <tr v-for="cinema in cinemas">
                <td>{{cinema.name}}</td>
                <td>{{cinema.address}}</td>
                <td v-on:click="setCinema(cinema)">购票</td>
            </tr>
        </table>
    </div>
    <!--第三页，电影和影院对应的场次-->
    <div id="buyTicket" v-if="displayNum==3">
        <h3>{{cinema.name}}</h3>
        <p>{{cinema.address}}</p>
        <div class="tags">
            <div v-for="movie in movies" v-on:click="setSelectedMovie(movie)">{{movie.name}}</div>
        </div>

        <div class="tags">
            <div v-on:click="setSelectedDate(date[0])">今天{{date[0]}}</div>
            <div v-on:click="setSelectedDate(date[1])">明天{{date[1]}}</div>
        </div>


        <table>
            <tr v-for="scene in selectedScenes">
                <td>{{scene.time}}</td>
                <td>{{scene.hallName}}</td>
                <td>{{scene.price}}</td>
                <td>购票</td>
            </tr>
        </table>


    </div>
</div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.20.1/moment.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
<script>
    let app = new Vue({
        el: '#app',
        data: function () {
            return {
                user:{},
                listNum: 1,
                displayNum: 1,
                movies: [],
                cinemas: [],
                cinema: null,
                scenes: [],
                selectedScenes: [],
                date: [],//记录今天明天日期
                todayScenes: [],
                tomorrowScenes: [],
                selectedDate: '',
                selectedMovie: '',
                scenesByDateAndMovie: [],
            };
        },
        methods: {
            //第一页显示表格1或者显示表格2
            list: function (listNum) {
                this.listNum = listNum;
            },
            setSelectedMovie(movie) {
                this.selectedMovie = movie;
            },
            //将场次按所选日期和电影进行筛选
            setSelectedDate: function (date) {
                this.selectedDate = date;
                let arr = [];
                let sceneDate = null;
                let time;
                for (i = 0; i < this.scenes.length; i++) {
                    sceneDate = moment(this.scenes[i].datetime).format('YYYY-MM-DD');
                    if (this.selectedDate == sceneDate && this.selectedMovie.id == this.scenes[i].movieId) {
                        time = moment(this.scenes[i].datetime).format('HH:mm');
                        this.scenes[i].time = time;
                        arr.push(this.scenes[i]);
                    }
                }
                this.selectedScenes = arr;
            },
            //往vue.movie传入参数
            setMovie: function (movie) {
                this.selectedMovie = movie;
                this.displayNum = 2;
            },
            //往vue.cinema传入参数
            setCinema: function (cinema) {
                this.cinema = cinema;
                this.getScenes(cinema.id);
                this.displayNum = 3;
            },
            //设置selectedMovie和selectedDate
            //获取该影院所有场次的信息
            getScenes: function (cinemaId) {
                axios.get('http://zhouzhaorong.xyz/order/selectSceneByCinemaId', {
                        params: {
                            cinemaId: cinemaId
                        }
                    }
                ).then((response) => {
                    this.scenes = response.data.data;
                    alert("111"+cinemaId)
                    //将场次信息分为今天场次和明天场次，并传入到todayScenes和tomorrowScenes
                    let sceneDate;
                    let arr1 = [];
                    let arr2 = [];
                    for (i = 0; i < this.scenes.length; i++) {
                        sceneDate = moment(this.scenes[i].datetime).format('YYYY-MM-DD');
                        if (this.date[0] == sceneDate) {
                            arr1.push(this.scenes[i])
                        } else if (this.date[1] == sceneDate) {
                            arr2.push(this.scenes[i])
                        }
                    }
                    this.todayScenes = arr1;
                    this.tomorrowScenes = arr2;
                });
            },
            //将timestamp转化为日期格式
            getDate: function (timestamp) {
                return moment(timestamp).format('YYYY-MM-DD')
            },
            //判断是否为微信浏览器访问
            isWechat: function () {
                if(ua.match(/MicroMessenger/i) == 'micromessenger'){
                    return true;
                }else{
                    return false;
                }
            },
            //注销
            logout:function () {
                axios.get('http://zhouzhaorong.xyz/user/logout').then((response)=>{
                        window.location="http://zhouzhaorong.xyz/login.html";
                    }
                )
            }
        },
        created: function () {
            //获取用户信息
            axios.get("http://zhouzhaorong.xyz/user/").then((response)=>{
                let code=response.data.code;
                if(code==200){
                    let user=response.data.data;
                    this.user=user;
                    /*alert("用户ID"+user.id)*/
                }
            }).catch(error=>{
                /*alert("error")*/
            }
            )

            //查询所有电影
            axios.get('http://zhouzhaorong.xyz/order/selectMovies').then((response) => {
                this.movies = response.data.data;
            });
            //查询所有影院
            axios.get('http://zhouzhaorong.xyz/order/selectCinemas').then((response) => {
                this.cinemas = response.data.data;
            });

            //今天的时间
            let todayDate = moment().format('YYYY-MM-DD');
            //明天时间
            let tomorrowDate = moment().add(1, 'days').format('YYYY-MM-DD');
            this.date = [todayDate, tomorrowDate]


        },
        mounted:function(){
            //如果是微信浏览器访问则发ajax到微信服务器去登陆
            let isWechat=null;
            let ua = window.navigator.userAgent.toLowerCase();
            if(ua.match(/MicroMessenger/i) == 'micromessenger'){
                isWechat= true;
            }else{
                isWechat=false;
            }
            if(isWechat){
                debugger;
                alert("微信浏览器访问")
                axios.get('https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx290c9f6319d3532c&redirect_uri=http://zhouzhaorong.xyz/user/wechatLogin&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect').then((response) => {
                    if(respones.data.code==200){
                        alert("登陆成功")
                    }
                }).catch((error)=>{
                    alert("登陆失败")
                });
            }else{
               /* alert("PC浏览器访问")*/
            }
        },
        computed: {},
        updated: function () {

        }
    })

</script>
</html>